<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager — Tabler UI (Cloud + Kanban DnD) — FIXED</title>

  <!-- Tabler CSS & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
  <style>
    body{background: radial-gradient(1200px 900px at 0% -20%, rgba(122,66,255,.15), transparent 60%), #0b0d13;}
    .kanban {display:grid; grid-template-columns:repeat(4,1fr); gap:1rem;}
    @media (max-width: 1024px){ .kanban{grid-template-columns:1fr 1fr} }
    @media (max-width: 640px){ .kanban{grid-template-columns:1fr} }
    .kanban-column {min-height: 260px;}
    .kanban-column .list-group{min-height:220px; padding: .5rem;}
    .badge-online{background:#0f2a1c; color:#b8f7ca; border:1px solid #1b6c3d;}
    .badge-offline{background:#2a1111; color:#ffd1d1; border:1px solid #7b1f1f;}
    .ti{vertical-align:-2px}
    .cursor-pointer{cursor:pointer}

    /* Priority chips */
    .prio-chip{border-radius:999px; padding:.25rem .5rem; font-size:.75rem}
    .prio-low{background:#1b3b2a; color:#b9f6ca; border:1px solid #1e6b45}
    .prio-med{background:#263050; color:#d1e1ff; border:1px solid #2f4782}
    .prio-high{background:#4b2b2b; color:#ffd1d1; border:1px solid #7b2f2f}
    .prio-crit{background:#5a120f; color:#ffdad9; border:1px solid #a52a2a}

    /* Avatar (initials) */
    .avatar-initials{
      width:28px; height:28px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:.75rem; font-weight:700;
      background:linear-gradient(180deg,#7a42ff,#513ae7); color:#fff;
    }

    /* Drag & Drop */
    .drop-target{ outline:2px dashed rgba(140,148,255,.35); outline-offset:-6px; }
    .dragging{ opacity:.6 }
  
    .modal .form-control, .modal .form-select {
      height: 42px;
    }

</style>
</head>
<body>
  <div class="page">
    <header class="navbar navbar-expand-md navbar-dark d-print-none">
      <div class="container-xl">
        <h1 class="navbar-brand navbar-brand-autodark pe-0 me-4">
          <span class="navbar-brand-text">Task Manager — Tabler UI</span>
        </h1>

        <div class="navbar-nav flex-row order-md-last">
          <span id="onlineBadge" class="badge me-3 badge-offline">OFFLINE</span>
          <a id="btnTheme" class="btn btn-icon" title="Тема">
            <i class="ti ti-sun"></i>
          </a>
          <a id="btnCloud" class="btn btn-primary ms-2" href="#!" onclick="cloudSave()">
            <i class="ti ti-cloud-upload me-1"></i> Сохранить в облако
          </a>
        </div>

        <div class="collapse navbar-collapse" id="navbar-menu">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a id="link-table" class="nav-link active" data-bs-toggle="tab" href="#tab-table" role="tab" aria-controls="tab-table" aria-selected="true">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <i class="ti ti-table"></i>
                </span>
                <span class="nav-link-title">Таблица</span>
              </a>
            </li>
            <li class="nav-item">
              <a id="link-kanban" class="nav-link" data-bs-toggle="tab" href="#tab-kanban" role="tab" aria-controls="tab-kanban" aria-selected="false">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <i class="ti ti-layout-kanban"></i>
                </span>
                <span class="nav-link-title">Канбан</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </header>

    <div class="page-wrapper">
      <div class="container-xl py-3">
        <div class="row g-3 align-items-end">
          <div class="col-sm-6 col-lg-3">
            <label class="form-label">Поиск</label>
            <input id="fltText" type="text" class="form-control" placeholder="Название, описание..." />
          </div>
          <div class="col-sm-6 col-lg-2">
            <label class="form-label">Статус</label>
            <select id="fltStatus" class="form-select"></select>
          </div>
          <div class="col-sm-6 col-lg-2">
            <label class="form-label">Приоритет</label>
            <select id="fltPrio" class="form-select"></select>
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label">От</label>
            <input id="fltDueFrom" type="date" class="form-control" />
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label">До</label>
            <input id="fltDueTo" type="date" class="form-control" />
          </div>
          <div class="col-12 col-lg-1">
            <button id="btnResetFilters" class="btn btn-outline-secondary w-100">Сброс</button>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body py-2 d-flex gap-2 flex-wrap">
            <button id="btnAdd" class="btn btn-primary"><i class="ti ti-plus me-1"></i> Добавить</button>
            <button id="btnExportExcel" class="btn btn-outline-warning"><i class="ti ti-file-spreadsheet me-1"></i> Экспорт Excel</button>
            <button id="btnExportCSV" class="btn btn-outline-secondary"><i class="ti ti-file-certificate me-1"></i> Экспорт CSV</button>
            <button id="btnImportExcel" class="btn btn-outline-secondary"><i class="ti ti-file-import me-1"></i> Импорт Excel</button>
            <button id="btnImportCSV" class="btn btn-outline-secondary"><i class="ti ti-database-import me-1"></i> Импорт CSV</button>
            <button id="btnSaveLocal" class="btn btn-outline-success"><i class="ti ti-device-floppy me-1"></i> В браузер</button>
            <button id="btnLoadLocal" class="btn btn-outline-info"><i class="ti ti-database me-1"></i> Из браузера</button>
            <button id="btnClearAll" class="btn btn-outline-danger"><i class="ti ti-trash me-1"></i> Очистить</button>
          </div>
        </div>

        <div class="tab-content mt-3">
          <div id="tab-table" class="tab-pane active show">
            <div class="card">
              <div class="table-responsive">
                <table class="table table-vcenter card-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Название</th>
                      <th>Статус</th>
                      <th>Приоритет</th>
                      <th>Ответственный</th>
                      <th>Дедлайн</th>
                      <th>Теги</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div id="tab-kanban" class="tab-pane">
            <div class="kanban" id="kanban"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal modal-blur fade" id="modalEdit" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" style="max-width:860px;" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Новая задача</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
            <div class="row g-3">
  <div class="col-sm-6">
    <label class="form-label">Название</label>
    <input id="fmTitle" type="text" class="form-control" />
  </div>
  <div class="col-sm-6">
    <label class="form-label">Ответственный</label>
    <input id="fmAssignee" type="text" class="form-control" />
  </div>
</div>
            <div class="row g-3">
  <div class="col-sm-4">
    <label class="form-label">Статус</label>
    <select id="fmStatus" class="form-select"></select>
  </div>
  <div class="col-sm-4">
    <label class="form-label">Приоритет</label>
    <select id="fmPrio" class="form-select"></select>
  </div>
  <div class="col-sm-4">
    <label class="form-label">Дедлайн</label>
    <input id="fmDue" type="date" class="form-control" />
  </div>
</div>
<div class="row g-3">
  <div class="col-12">
    <label class="form-label">Теги (через запятую)</label>
    <input id="fmTags" type="text" class="form-control" />
  </div>
</div>
<div class="row g-3">
  <div class="col-12">
    <label class="form-label">Описание</label>
    <textarea id="fmDesc" rows="3" class="form-control"></textarea>
  </div>
</div>
          </div>
            <div class="mt-4">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h3 class="m-0">Комментарии</h3>
                <span class="badge bg-indigo-lt" id="cmCount">0</span>
              </div>
              <div class="card mb-2">
                <div class="card-body p-2" id="commentsList" style="max-height:30vh; overflow:auto"></div>
              </div>
              <div class="row g-2">
                <div class="col-sm-4"><input id="fmCommentAuthor" type="text" class="form-control form-control-sm" placeholder="Автор (необязательно)" /></div>
                <div class="col-sm-8"><textarea id="fmCommentText" rows="2" class="form-control" placeholder="Ваш комментарий… (Ctrl+Enter — отправить)"></textarea></div>
              </div>
              <button id="btnAddComment" class="btn btn-primary mt-2"><i class="ti ti-message-plus me-1"></i> Добавить комментарий</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="btnDelete" class="btn btn-danger me-auto" style="display:none"><i class="ti ti-trash"></i> Удалить</button>
          <button class="btn me-2" data-bs-dismiss="modal">Отмена</button>
          <button id="btnSave" class="btn btn-primary"><i class="ti ti-device-floppy"></i> Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="fileExcel" accept=".xlsx,.xls" hidden />
  <input type="file" id="fileCSV" accept=".csv" hidden />

  <!-- IMPORTANT: Ensure Bootstrap 5 is present so tabs & modal work and window.bootstrap is defined -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Tabler JS (after Bootstrap bundle) -->
  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  // ====== CLOUD CONFIG (вшито) ======
  let CLOUD_URL     = "https://script.google.com/macros/s/AKfycbyq_1gmzUt40zMTvk5SqzAQxMuocwz9ApOXTyuJk-fFKCjAYbBn5KzKMmc0goTwxfw4/exec";
  let CLOUD_PROFILE = "default";
  let CLOUD_MODE    = "jsonp";

  // ====== DATA ======
  const STATUS_CHOICES = ["Новая","В работе","Ожидает","Готово","Отменена"];
  const PRIORITY_CHOICES = ["Низкий","Средний","Высокий","Критично"];
  let tasks = [];
  let editingId = null;

  // ====== UI helpers ======
  const $ = (s, root=document) => root.querySelector(s);

  function setOnlineBadge(state){
    const el = $("#onlineBadge");
    if(state){ el.textContent = "ONLINE · " + CLOUD_PROFILE; el.className = "badge me-3 badge-online"; }
    else { el.textContent = "OFFLINE"; el.className = "badge me-3 badge-offline"; }
  }

  // Theme toggle
  $("#btnTheme").addEventListener("click", ()=>{
    const html = document.documentElement;
    const isDark = html.getAttribute("data-bs-theme") !== "light";
    html.setAttribute("data-bs-theme", isDark ? "light" : "dark");
    $("#btnTheme .ti").className = "ti " + (isDark ? "ti-moon" : "ti-sun");
  });

  // ====== JSONP helper ======
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb="cb_"+Math.random().toString(36).slice(2);
      window[cb]=(data)=>{ resolve(data); cleanup(); };
      function cleanup(){ delete window[cb]; script.remove(); clearTimeout(t); }
      const script=document.createElement("script");
      script.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
      script.onerror=()=>{ reject(new Error("JSONP error")); cleanup(); };
      document.body.appendChild(script);
      const t=setTimeout(()=>{ reject(new Error("JSONP timeout")); cleanup(); }, 8000);
    });
  }

  // ====== Cloud (load/save) ======
  async function cloudLoad(){
    try{
      if(CLOUD_MODE==="jsonp"){
        const data = await jsonp(`${CLOUD_URL}?profile=${encodeURIComponent(CLOUD_PROFILE)}`);
        if(data && Array.isArray(data.tasks)){ tasks = data.tasks; drawTable(); drawKanban(); setOnlineBadge(true); return; }
        throw new Error("bad jsonp result");
      }else{
        const r = await fetch(`${CLOUD_URL}?profile=${encodeURIComponent(CLOUD_PROFILE)}`);
        const data = await r.json();
        if(data && Array.isArray(data.tasks)){ tasks = data.tasks; drawTable(); drawKanban(); setOnlineBadge(true); return; }
        throw new Error("bad fetch result");
      }
    }catch(e){ console.warn(e); setOnlineBadge(false); }
  }

  async function cloudSave(){
    try{
      if(CLOUD_MODE==="jsonp"){
        await jsonp(`${CLOUD_URL}?profile=${encodeURIComponent(CLOUD_PROFILE)}&write=1&data=${encodeURIComponent(JSON.stringify(tasks))}`);
        setOnlineBadge(true);
      }else{
        await fetch(`${CLOUD_URL}?profile=${encodeURIComponent(CLOUD_PROFILE)}`, {
          method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({tasks}), mode:"no-cors"
        });
        setOnlineBadge(true);
      }
    }catch(e){ console.warn(e); setOnlineBadge(false); }
  }

  // ====== Filters ======
  function fillFilters(){
    $("#fltStatus").innerHTML = '<option value="">Любой</option>' + STATUS_CHOICES.map(s=>`<option>${s}</option>`).join("");
    $("#fltPrio").innerHTML = '<option value="">Любой</option>' + PRIORITY_CHOICES.map(s=>`<option>${s}</option>`).join("");
  }

  function passFilters(t){
    const q = $("#fltText").value.trim().toLowerCase();
    const st = $("#fltStatus").value; const pr = $("#fltPrio").value;
    const df = $("#fltDueFrom").value; const dt = $("#fltDueTo").value;
    if(q){ const blob=((t.Название||"")+" "+(t.Описание||"")).toLowerCase(); if(!blob.includes(q)) return false; }
    if(st && t.Статус!==st) return false;
    if(pr && t.Приоритет!==pr) return false;
    const due = t.Дедлайн ? new Date(t.Дедлайн) : null;
    if(df && (!due || due < new Date(df+"T00:00:00"))) return false;
    if(dt && (!due || due > new Date(dt+"T23:59:59"))) return false;
    return true;
  }

  ["#fltText","#fltStatus","#fltPrio","#fltDueFrom","#fltDueTo"].forEach(sel=>{
    $(sel).addEventListener("input", ()=>{ drawTable(); drawKanban(); });
    $(sel).addEventListener("change", ()=>{ drawTable(); drawKanban(); });
  });

  $("#btnResetFilters").addEventListener("click", ()=>{
    $("#fltText").value=""; $("#fltStatus").value=""; $("#fltPrio").value="";
    $("#fltDueFrom").value=""; $("#fltDueTo").value="";
    drawTable(); drawKanban();
  });

  // ====== Table ======
  function prioChip(p){
    const m = {
      "Низкий":"prio-low","Средний":"prio-med","Высокий":"prio-high","Критично":"prio-crit"
    };
    return `<span class="prio-chip ${m[p]||'prio-med'}">${p||''}</span>`;
  }
  function initials(name){
    const s = (name||"").trim().split(/\s+/).slice(0,2).map(w=>w[0]?.toUpperCase()||"").join("");
    return `<span class="avatar-initials" title="${name||''}">${s||"?"}</span>`;
  }
  function optionList(val, arr){return arr.map(s=>`<option ${s===val?'selected':''}>${s}</option>`).join("")}
function drawTable(){
    const tbody = $("#tbody"); tbody.innerHTML = "";
    tasks.filter(passFilters).forEach(t=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.ID ?? ""}</td>
        <td class="cursor-pointer text-primary">${escapeHtml(t.Название||"")}</td>
        <td><select class="form-select form-select-sm" data-inline-status>${optionList(t.Статус||"Новая", STATUS_CHOICES)}</select></td>
        <td><select class="form-select form-select-sm" data-inline-prio>${optionList(t.Приоритет||"Средний", PRIORITY_CHOICES)}</select></td>
        <td>${initials(t.Ответственный)} <span class="ms-1">${escapeHtml(t.Ответственный||"")}</span></td>
        <td>${t.Дедлайн ? new Date(t.Дедлайн).toLocaleDateString('ru-RU') : ""}</td>
        <td>${(t.Теги||"").split(",").filter(Boolean).map(s=>`<span class="badge bg-indigo-lt me-1">${escapeHtml(s.trim())}</span>`).join("")}<span class="badge bg-indigo-lt ms-1">${(t.Комментарии||[]).length||0}</span></td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary me-1" data-edit>Ред.</button>
          <button class="btn btn-sm btn-outline-danger" data-del>Удалить</button>
        </td>`;
      tr.querySelector("[data-edit]").addEventListener("click", ()=>openModal(t.ID));
      tr.querySelector("[data-del]").addEventListener("click", ()=>{ if(confirm("Удалить?")){ tasks = tasks.filter(x=>x.ID!==t.ID); cloudSave(); drawTable(); drawKanban(); }});
      tr.children[1].addEventListener("click", ()=>openModal(t.ID));
      tr.querySelector("[data-inline-status]").addEventListener("change", (e)=>{ const v=e.target.value; const i=tasks.findIndex(x=>x.ID===t.ID); if(i>=0){ tasks[i].Статус=v; tasks[i].Обновлено=new Date().toISOString(); cloudSave(); drawKanban(); }});
      tr.querySelector("[data-inline-prio]").addEventListener("change", (e)=>{ const v=e.target.value; const i=tasks.findIndex(x=>x.ID===t.ID); if(i>=0){ tasks[i].Приоритет=v; tasks[i].Обновлено=new Date().toISOString(); cloudSave(); drawKanban(); }});
      tbody.appendChild(tr);
    });
  }

  // ====== Kanban (with Drag & Drop) ======
  function drawKanban(){
    const root = $("#kanban"); root.innerHTML="";
    const groups = STATUS_CHOICES.map(s=>({name:s, items:[] }));
    tasks.filter(passFilters).forEach(t=>{
      const i = Math.max(0, STATUS_CHOICES.indexOf(t.Статус||"Новая"));
      groups[i].items.push(t);
    });
    groups.forEach(g=>{
      const col = document.createElement("div");
      col.className = "card kanban-column";
      col.innerHTML = `
        <div class="card-header"><h3 class="card-title">${g.name}</h3></div>
        <div class="list-group list-group-flush" data-col="${g.name}"></div>`;
      const list = col.querySelector(".list-group");
      // Allow drop
      list.addEventListener("dragover", (e)=>{ e.preventDefault(); if(e.dataTransfer){ e.dataTransfer.dropEffect = "move"; } list.classList.add("drop-target"); });
      list.addEventListener("dragleave", ()=>{ list.classList.remove("drop-target"); });
      list.addEventListener("drop", (e)=>{ e.preventDefault(); list.classList.remove("drop-target"); kanbanDrop(list, e); });

      g.items.forEach(t=>{
        const item = document.createElement("div");
        item.className = "list-group-item";
        item.setAttribute("draggable","true");
        item.dataset.id = t.ID;
        item.addEventListener("dragstart", kanbanDragStart);
        item.addEventListener("dragend", kanbanDragEnd);
        item.innerHTML = `
          <div class="row align-items-center">
            <div class="col"><strong class="cursor-pointer text-primary">${escapeHtml(t.Название||"")}</strong>
              <div class="text-secondary small">${initials(t.Ответственный)} <span class="ms-1">${escapeHtml(t.Ответственный||"")}</span> · ${t.Дедлайн?new Date(t.Дедлайн).toLocaleDateString('ru-RU'):""}</div>
            </div>
            <div class="col-auto">
              ${prioChip(t.Приоритет)}
              <span class="badge bg-indigo-lt ms-2">${(t.Комментарии||[]).length||0}</span>
              <button class="btn btn-sm btn-outline ms-2" data-edit><i class="ti ti-pencil"></i></button>
            </div>
          </div>`;
        item.querySelector("[data-edit]").addEventListener("click", ()=>openModal(t.ID));
        item.querySelector(".cursor-pointer").addEventListener("click", ()=>openModal(t.ID));
        list.appendChild(item);
      });
      root.appendChild(col);
    });
  }

  // DnD handlers
  let dragId = null;
  function kanbanDragStart(e){
    dragId = e.currentTarget.dataset.id;
    e.currentTarget.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
    try { e.dataTransfer.setData("text/plain", dragId); } catch(_){}
  }
  function kanbanDragEnd(e){
    e.currentTarget.classList.remove("dragging");
    dragId = null;
  }
  function kanbanDrop(list, e){
    let id = dragId;
    try{ const d = e?.dataTransfer?.getData("text/plain"); if(d) id=d; }catch(_){ }
    if(!id) return;
    const status = list.getAttribute("data-col");
    const idx = tasks.findIndex(t=>String(t.ID)===String(id));
    if(idx>=0){
      tasks[idx].Статус = status;
      tasks[idx].Обновлено = new Date().toISOString();
      cloudSave(); drawKanban(); drawTable();
    }
  }

  // ====== Comments ======
  function getTaskById(id){ return tasks.find(x=>String(x.ID)===String(id)); }

  function ensureComments(task){
    if(!task.Комментарии) task.Комментарии = [];
    return task.Комментарии;
  }

  function renderComments(id){
    const task = getTaskById(id);
    const list = document.getElementById("commentsList");
    const cnt  = document.getElementById("cmCount");
    if(!task){ list.innerHTML = '<div class="text-secondary">Задача не найдена</div>'; cnt.textContent='0'; return; }
    const comments = ensureComments(task);
    cnt.textContent = comments.length;
    if(!comments.length){ list.innerHTML = '<div class="text-secondary">Пока нет комментариев</div>'; return; }
    list.innerHTML = comments.map(c=>{
      const init = (c.author||"?").trim().slice(0,2).toUpperCase() || "?";
      const t = new Date(c.time||Date.now());
      const when = isNaN(+t) ? "" : t.toLocaleString('ru-RU');
      return `
        <div class="list-group list-group-flush mb-2">
          <div class="list-group-item">
            <div class="row align-items-center">
              <div class="col-auto"><span class="avatar-initials" title="${escapeHtml(c.author||'')}">${init}</span></div>
              <div class="col">
                <div class="strong">${escapeHtml(c.author||'')}</div>
                <div class="text-secondary small">${escapeHtml(when)}</div>
              </div>
              <div class="col-auto">
                <button class="btn btn-sm btn-outline-danger" data-del-cm="${c.id}"><i class="ti ti-trash"></i></button>
              </div>
            </div>
            <div class="mt-2">${escapeHtml(c.text||'')}</div>
          </div>
        </div>`;
    }).join("");

    // attach delete listeners
    list.querySelectorAll("[data-del-cm]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cid = btn.getAttribute("data-del-cm");
        const t = getTaskById(id); if(!t) return;
        t.Комментарии = (t.Комментарии||[]).filter(x=>String(x.id)!==String(cid));
        t.Обновлено = new Date().toISOString();
        cloudSave(); renderComments(id);
      });
    });
  }

  function addCommentToTask(id, author, text){
    const t = getTaskById(id); if(!t) return;
    const cm = ensureComments(t);
    const newItem = { id: (cm.length? Math.max(...cm.map(x=>Number(x.id)||0))+1 : 1), author: (author||'').trim() || '', text: (text||'').trim(), time: new Date().toISOString() };
    if(!newItem.text) return alert("Введите текст комментария");
    cm.push(newItem);
    t.Обновлено = new Date().toISOString();
    cloudSave(); renderComments(id);
  }

  // ====== Modal ======
  function openModal(id=null){
    editingId = id;
    $("#modalTitle").textContent = id ? "Задача #"+id : "Новая задача";
    $("#fmStatus").innerHTML = STATUS_CHOICES.map(s=>`<option>${s}</option>`).join("");
    $("#fmPrio").innerHTML = PRIORITY_CHOICES.map(s=>`<option>${s}</option>`).join("");
    $("#btnDelete").style.display = id ? "" : "none";

    $("#fmTitle").value=""; $("#fmAssignee").value=""; $("#fmDue").value=""; $("#fmTags").value=""; $("#fmDesc").value="";
    if(id){
      const t = tasks.find(x=>x.ID===id); if(!t) return;
      $("#fmTitle").value = t.Название||"";
      $("#fmAssignee").value = t.Ответственный||"";
      $("#fmStatus").value = t.Статус||"Новая";
      $("#fmPrio").value = t.Приоритет||"Средний";
      $("#fmDue").value = t.Дедлайн ? isoToYMD(t.Дедлайн) : "";
      $("#fmTags").value = t.Теги||"";
      $("#fmDesc").value = t.Описание||"";
    }
    document.getElementById("fmCommentAuthor").value = $("#fmAssignee").value || "";
    renderComments(id ?? editingId);

    if (window.bootstrap?.Modal) {
      const modal = new bootstrap.Modal(document.getElementById("modalEdit"));
      modal.show();
    } else {
      alert("Bootstrap не загружен. Проверьте соединение.");
    }
  }

  document.getElementById("btnSave").addEventListener("click", ()=>{
    const now = new Date().toISOString();
    const payload = {
      ID: editingId ?? nextId(),
      Название: $("#fmTitle").value.trim(),
      Описание: $("#fmDesc").value.trim(),
      Статус: $("#fmStatus").value,
      Приоритет: $("#fmPrio").value,
      Ответственный: $("#fmAssignee").value.trim(),
      Дедлайн: $("#fmDue").value ? (new Date($("#fmDue").value+"T12:00:00Z").toISOString()) : null,
      Теги: $("#fmTags").value.trim(),
      Обновлено: now
    };
    if(!payload.Название){ alert("Введите название"); return; }

    if(editingId){
      const i = tasks.findIndex(x=>x.ID===editingId);
      if(i>=0){ tasks[i] = {...tasks[i], ...payload}; }
    }else{
      tasks.push({...payload, Создано: now });
    }
    cloudSave(); drawTable(); drawKanban();
    const inst = bootstrap.Modal.getInstance(document.getElementById("modalEdit"));
    if (inst) inst.hide();
  });

  
  // Comment add + shortcuts
  document.getElementById("btnAddComment").addEventListener("click", ()=>{
    addCommentToTask(editingId, document.getElementById("fmCommentAuthor").value, document.getElementById("fmCommentText").value);
    document.getElementById("fmCommentText").value="";
  });
  document.getElementById("fmCommentText").addEventListener("keydown", (e)=>{
    if(e.key==='Enter' && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      document.getElementById("btnAddComment").click();
    }
  });
document.getElementById("btnDelete").addEventListener("click", ()=>{
    if(editingId && confirm("Удалить задачу?")){
      tasks = tasks.filter(x=>x.ID!==editingId);
      cloudSave(); drawTable(); drawKanban();
      const inst = bootstrap.Modal.getInstance(document.getElementById("modalEdit"));
      if (inst) inst.hide();
    }
  });

  // ====== Import/Export ======
  document.getElementById("btnImportExcel").addEventListener("click", ()=>$("#fileExcel").click());
  document.getElementById("btnImportCSV").addEventListener("click", ()=>$("#fileCSV").click());

  document.getElementById("btnExportExcel").addEventListener("click", ()=>{
    const out = tasks.map(toRowExport);
    const ws = XLSX.utils.json_to_sheet(out); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Задачи");
    XLSX.writeFile(wb,"Задачи.xlsx");
  });

  document.getElementById("btnExportCSV").addEventListener("click", ()=>{
    const out = tasks.map(toRowExport);
    const ws = XLSX.utils.json_to_sheet(out); const csv = XLSX.utils.sheet_to_csv(ws);
    const a = document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"})); a.download="Задачи.csv"; a.click();
  });

  document.getElementById("fileExcel").addEventListener("change", async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const buf=await f.arrayBuffer(); const wb=XLSX.read(buf,{type:"array"}); const sh=wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(sh,{defval:""});
      tasks = json.map(fromRowImport); drawTable(); drawKanban(); cloudSave();
    }catch(err){ alert("Не удалось импортировать Excel: "+err.message); }
    e.target.value="";
  });

  document.getElementById("fileCSV").addEventListener("change", async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const txt = await f.text();
      const wb = XLSX.read(txt,{type:"string", raw:true});
      const sh = wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(sh,{defval:""});
      tasks = json.map(fromRowImport); drawTable(); drawKanban(); cloudSave();
    }catch(err){ alert("Не удалось импортировать CSV: "+err.message); }
    e.target.value="";
  });

  function toRowExport(t){
    return {
      ID:t.ID, Название:t.Название, Описание:t.Описание, Статус:t.Статус, Приоритет:t.Приоритет,
      Ответственный:t.Ответственный, Дедлайн: t.Дедлайн? isoToYMD(t.Дедлайн):"", Теги:t.Теги||"",
      Создано: t.Создано? isoToYMD(t.Создано):"", Обновлено: t.Обновлено? isoToYMD(t.Обновлено):""
    };
  }

  function fromRowImport(r){
    return {
      ID: Number(r.ID)||nextId(),
      Название: r.Название||r.title||"",
      Описание: r.Описание||r.desc||"",
      Статус: r.Статус||r.status||"Новая",
      Приоритет: r.Приоритет||r.priority||"Средний",
      Ответственный: r.Ответственный||r.assignee||"",
      Дедлайн: (r.Дедлайн||r.due)? new Date((r.Дедлайн||r.due)+"T12:00:00Z").toISOString(): null,
      Теги: r.Теги||r.tags||"",
      Создано: new Date().toISOString(),
      Обновлено: new Date().toISOString()
    };
  }

  // ====== Local & utils ======
  document.getElementById("btnSaveLocal").addEventListener("click", ()=>{ localStorage.setItem("tm_tasks", JSON.stringify(tasks)); });
  document.getElementById("btnLoadLocal").addEventListener("click", ()=>{ const raw=localStorage.getItem("tm_tasks"); if(raw){ tasks=JSON.parse(raw); drawTable(); drawKanban(); }});
  document.getElementById("btnClearAll").addEventListener("click", ()=>{ if(confirm("Очистить все?")){ tasks=[]; drawTable(); drawKanban(); cloudSave(); }});

  // Simple programmatic tabs (in case data-bs-toggle fails inside navbar)
  function activateTab(targetId){
    document.querySelectorAll(".tab-pane").forEach(p=>p.classList.remove("active","show"));
    document.querySelectorAll(".navbar .nav-link").forEach(a=>a.classList.remove("active"));
    const pane = document.querySelector(targetId);
    if(pane){ pane.classList.add("active","show"); }
    const link = document.querySelector(`.navbar .nav-link[href="${targetId}"]`);
    if(link){ link.classList.add("active"); }
  }
  document.getElementById("link-table").addEventListener("click", (e)=>{ e.preventDefault(); activateTab("#tab-table"); });
  document.getElementById("link-kanban").addEventListener("click", (e)=>{ e.preventDefault(); activateTab("#tab-kanban"); });

  function nextId(){ const ids=tasks.map(x=>Number(x.ID)||0); const m = ids.length?Math.max(...ids):0; return m+1; }
  function isoToYMD(iso){ if(!iso) return ""; const d=new Date(iso); if(isNaN(+d)) return ""; return d.toISOString().slice(0,10); }
  function escapeHtml(s){ return String(s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c])); }

  // ====== Init ======
  document.getElementById("btnAdd").addEventListener("click", ()=>openModal(null));
  fillFilters();
  (async function init(){
    try{ const raw=localStorage.getItem("tm_tasks"); if(raw){ tasks=JSON.parse(raw);} }catch{}
    drawTable(); drawKanban();
    await cloudLoad();
  })();
  </script>
</body>
</html>
