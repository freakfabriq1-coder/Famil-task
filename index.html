<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Task Manager (HTML) — Pro</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">
// ===== JSON Import/Export =====
document.getElementById("btnImportJSON").addEventListener("click", ()=>document.getElementById("fileJSON").click());
document.getElementById("fileJSON").addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);
    if(!Array.isArray(obj)) throw new Error("Формат: ожидается массив задач");
    tasks = obj;
    drawRows(); saveLocalSilent();
    alert("Импортировано задач: "+tasks.length);
  }catch(err){ alert("Ошибка импорта JSON: "+err.message); }
  finally{ e.target.value=""; }
});
document.getElementById("btnExportJSON").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tasks.tm.json"; document.body.appendChild(a); a.click(); a.remove();
});

// ===== Cloud (Google Sheets via Apps Script) =====
const modalCloud = document.getElementById("modalCloud");
document.getElementById("btnCloud").addEventListener("click", ()=>{ 
  // preload settings
  document.getElementById("cloudUrl").value = localStorage.getItem("tm_cloud_url") || "";
  document.getElementById("cloudKey").value = localStorage.getItem("tm_cloud_key") || "";
  document.getElementById("cloudProfile").value = localStorage.getItem("tm_cloud_profile") || "default";
  modalCloud.classList.add("open"); 
});
document.getElementById("btnCloseCloud").addEventListener("click", ()=>modalCloud.classList.remove("open"));

document.getElementById("btnCloudLoad").addEventListener("click", async ()=>{
  const url = document.getElementById("cloudUrl").value.trim();
  const key = document.getElementById("cloudKey").value.trim();
  const profile = document.getElementById("cloudProfile").value.trim() || "default";
  if(!url){ alert("Укажите URL вашего Apps Script веб‑приложения"); return; }
  localStorage.setItem("tm_cloud_url", url);
  localStorage.setItem("tm_cloud_key", key);
  localStorage.setItem("tm_cloud_profile", profile);
  try{
    const resp = await fetch(`${url}?action=get&profile=${encodeURIComponent(profile)}&key=${encodeURIComponent(key)}`, {method:"GET"});
    if(!resp.ok){ throw new Error("HTTP "+resp.status); }
    const data = await resp.json();
    if(!Array.isArray(data.tasks)){ throw new Error("Неверный ответ сервера"); }
    tasks = data.tasks;
    drawRows(); saveLocalSilent();
    alert("Загружено задач: "+tasks.length);
  }catch(err){ alert("Ошибка загрузки: "+err.message); }
});

document.getElementById("btnCloudSave").addEventListener("click", async ()=>{
  const url = document.getElementById("cloudUrl").value.trim();
  const key = document.getElementById("cloudKey").value.trim();
  const profile = document.getElementById("cloudProfile").value.trim() || "default";
  if(!url){ alert("Укажите URL вашего Apps Script веб‑приложения"); return; }
  localStorage.setItem("tm_cloud_url", url);
  localStorage.setItem("tm_cloud_key", key);
  localStorage.setItem("tm_cloud_profile", profile);
  try{
    const resp = await fetch(`${url}?action=save&profile=${encodeURIComponent(profile)}&key=${encodeURIComponent(key)}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ tasks })
    });
    if(!resp.ok){ throw new Error("HTTP "+resp.status); }
    alert("Сохранено в облако.");
  }catch(err){ alert("Ошибка сохранения: "+err.message); }
});


// ===== URL params & Cloud Autosync =====
function b64urlDecode(str){
  try{
    str = str.replace(/-/g,'+').replace(/_/g,'/');
    const pad = str.length % 4; if (pad) str += '='.repeat(4-pad);
    return decodeURIComponent(escape(atob(str)));
  }catch(e){ return ""; }
}
function getQP(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

let CLOUD_URL = null;
let CLOUD_KEY = null;
let CLOUD_PROFILE = null;
let autosyncEnabled = false;
let saveTimer = null;

function setOnlineBadge(state){
  const el = document.getElementById("onlineBadge");
  if(!el) return;
  if(state){
    el.textContent = `ONLINE${CLOUD_PROFILE?` · ${CLOUD_PROFILE}`:""}`;
    el.style.background = "#0b3a22";
    el.style.color = "#b9f6ca";
    el.style.borderColor = "#155e38";
  }else{
    el.textContent = "OFFLINE";
    el.style.background = "#3a1a1a";
    el.style.color = "#fecaca";
    el.style.borderColor = "#7f1d1d";
  }
}

async function cloudLoad(){
  if(!CLOUD_URL) return;
  try{
    const resp = await fetch(`${CLOUD_URL}?action=get&profile=${encodeURIComponent(CLOUD_PROFILE||"default")}&key=${encodeURIComponent(CLOUD_KEY||"")}`);
    if(!resp.ok) throw new Error("HTTP "+resp.status);
    const data = await resp.json();
    if(Array.isArray(data.tasks)){
      tasks = data.tasks;
      drawRows(); saveLocalSilent(); setOnlineBadge(true);
    }
  }catch(e){
    console.warn("cloudLoad error:", e); setOnlineBadge(false);
  }
}
async function cloudSave(){
  if(!CLOUD_URL) return;
  try{
    const resp = await fetch(`${CLOUD_URL}?action=save&profile=${encodeURIComponent(CLOUD_PROFILE||"default")}&key=${encodeURIComponent(CLOUD_KEY||"")}`, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({tasks})
    });
    if(!resp.ok) throw new Error("HTTP "+resp.status);
    setOnlineBadge(true);
  }catch(e){
    console.warn("cloudSave error:", e); setOnlineBadge(false);
  }
}
function scheduleCloudSave(){
  if(!autosyncEnabled) return;
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(cloudSave, 800); // debounce 0.8s
}

// Hook all mutations to schedule save
const origDrawRows = drawRows;
drawRows = function(){
  origDrawRows();
  scheduleCloudSave();
}

// Patch inline changes to schedule save
const origSaveLocal = saveLocalSilent;
saveLocalSilent = function(){
  try{ localStorage.setItem("tm_tasks", JSON.stringify(tasks)); }catch(e){}
  scheduleCloudSave();
}

// Parse URL params
(function(){
  const cloudParam = getQP("cloud"); // base64url-encoded Apps Script URL
  const profileParam = getQP("profile") || getQP("doc") || getQP("id");
  const keyParam = getQP("key") || getQP("token");
  if(cloudParam){
    const decoded = b64urlDecode(cloudParam);
    if(decoded && /^https?:\/\/script\.google\.com\/macros\//.test(decoded)){
      CLOUD_URL = decoded;
      CLOUD_PROFILE = profileParam || "default";
      CLOUD_KEY = keyParam || "";
      autosyncEnabled = true;
      setOnlineBadge(true);
      // Auto-load from cloud on init
      cloudLoad();
    }else{
      console.warn("cloud param not valid");
    }
  } else {
    setOnlineBadge(false);
  }
})();

</script>
<style>
:root{
  --bg:#0d0e12; --panel:#131521; --card:#171a29;
  --muted:#8b90aa; --text:#e9ecf5; --brand:#6A0DAD; --gold:#D4AF37;
  --danger:#ef4444; --ok:#10b981; --border:#22263a; --input:#0f1220;
  --shadow: 0 8px 30px rgba(0,0,0,0.25);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
  background: radial-gradient(1200px 900px at 10% -10%, rgba(122,61,199,.18), transparent 60%),
              radial-gradient(1000px 800px at 110% 10%, rgba(212,175,55,.12), transparent 60%),
              var(--bg);}
.container{max-width:1200px;margin:28px auto;padding:0 16px}
.header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.brand .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),#a05cff);box-shadow:var(--shadow)}
.title{font-weight:700;font-size:20px;letter-spacing:.2px}
.subtitle{color:var(--muted);font-size:13px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px}
button,.btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#1a1d2d,#121522);
  color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;font-size:13px;transition:transform .05s ease, border-color .2s ease, background .2s ease}
button:hover{border-color:#2b3152} button:active{transform:translateY(1px)}
.btn-primary{background:linear-gradient(180deg,#7e32cf,#6125a8);border-color:#7f3bd2}
.btn-gold{background:linear-gradient(180deg,#d8b756,#b3922a);border-color:#d4af37;color:#1b1305}
.btn-danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#ef4444}
.btn-ghost{background:transparent}
.panel{background:rgba(19,21,33,.8);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
.section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 12px 0}
.section-title h2{font-size:16px;margin:0}.section-title .hint{color:var(--muted);font-size:12px}
.filters{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:12px}
@media (max-width:980px){.filters{grid-template-columns:1fr 1fr}}
@media (max-width:640px){.filters{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--input);color:var(--text);outline:none;font-size:14px}
.input:focus,select:focus,textarea:focus{border-color:#37406a}
.table-wrap{overflow:auto;margin-top:12px;border-radius:12px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;min-width:900px}
th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
th{position:sticky;top:0;background:#15182b;z-index:5;user-select:none;cursor:pointer}
tr:hover td{background:#14182a}
.badge{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#232844;color:#cbd5e1}
.row-actions{display:flex;gap:6px;flex-wrap:wrap}
.tag{display:inline-block;padding:2px 8px;font-size:12px;border-radius:999px;background:#21305a;color:#c7d2fe;border:1px solid #26376b;margin:2px 4px 0 0}
.kbd{border:1px solid var(--border);background:#0e1220;padding:2px 6px;border-radius:6px;color:var(--muted);font-size:12px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:10000}
.modal.open{display:flex}
.modal-card{width:min(860px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);z-index:10001}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.modal-head h3{margin:0;font-size:18px}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:760px){.modal-grid{grid-template-columns:1fr}}
.modal-actions{display:flex;gap:8px;justify-content:space-between;margin-top:12px;align-items:center}
.files{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.file-card{border:1px solid var(--border);border-radius:12px;padding:8px;background:#121525}
.file-card img{width:100%;height:100px;object-fit:cover;border-radius:8px}
.file-name{font-size:12px;color:var(--muted);margin-top:6px;word-break:break-word}
.file-actions{display:flex;gap:6px;margin-top:6px}
footer{margin:18px 0;color:var(--muted);font-size:12px;text-align:center}
.link{color:#c7aefc;text-decoration:none;border-bottom:1px dashed #7f5cff}
.link:hover{color:white;border-color:white}
select.inline{background:#11152a;border-color:#2b3152}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Task Manager — HTML Pro</div>
          <div class="subtitle">Импорт/Экспорт Excel/CSV · Фильтры · Инлайн-правка статуса/приоритета · Вложения</div>
        </div>
      </div>
      <div class="toolbar"><span id="onlineBadge" class="badge">OFFLINE</span>
        <button class="btn" id="btnImportExcel">Импорт Excel</button>
        <button class="btn" id="btnImportCSV">Импорт CSV</button>
        <button class="btn btn-gold" id="btnExportExcel">Экспорт Excel</button>
        <button class="btn" id="btnExportCSV">Экспорт CSV</button>
        <button class="btn btn-primary" id="btnSaveLocal">Сохранить в браузере</button>
        <button class="btn" id="btnLoadLocal">Загрузить из браузера</button>
        <button class="btn btn-danger" id="btnClearAll">Очистить всё</button>
        <button class="btn" id="btnImportJSON">Импорт JSON</button>
        <button class="btn btn-gold" id="btnExportJSON">Экспорт JSON</button>
        <button class="btn" id="btnCloud">Облако (Google Sheets)</button>
        <button class="btn btn-primary" id="btnAdd">+ Добавить задачу</button>
      </div>
    </div>

    <div class="panel">
      <div class="section-title">
        <h2>Фильтры и поиск</h2>
        <div class="hint">Клик по заголовку — сортировка. Щёлкни по строке — подробности и вложения.</div>
      </div>
      <div class="filters">
        <input class="input" id="fltText" placeholder="Поиск в названии/описании..." />
        <select id="fltStatus"><option value="">Статус — любой</option></select>
        <select id="fltPrio"><option value="">Приоритет — любой</option></select>
        <input class="input" id="fltAssignee" placeholder="Ответственный содержит..." />
        <input class="input" type="date" id="fltDueFrom" />
        <input class="input" type="date" id="fltDueTo" />
      </div>
      <div class="filters" style="margin-top:10px">
        <input class="input" id="fltTags" placeholder="Теги (подстрока или #tag)" />
        <button class="btn" id="btnResetFilters">Сбросить фильтры</button>
      </div>

      <div class="table-wrap">
        <table id="taskTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <footer>Сделано с любовью к порядку • Для Excel-импорта нужен интернет (SheetJS CDN).</footer>
  </div>

  <input type="file" id="fileExcel" accept=".xlsx,.xls" style="display:none" />
  <input type="file" id="fileCSV" accept=".csv" style="display:none" />
  <input type="file" id="fileJSON" accept=".json" style="display:none" />

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="modalTitle">Новая задача</h3>
        <button class="btn btn-ghost" id="btnCloseModal">✕</button>
      </div>
      <div class="modal-grid">
        <div>
          <label>Название</label>
          <input class="input" id="fmTitle" />
        </div>
        <div>
          <label>Ответственный</label>
          <input class="input" id="fmAssignee" />
        </div>
        <div>
          <label>Статус</label>
          <select id="fmStatus"></select>
        </div>
        <div>
          <label>Приоритет</label>
          <select id="fmPrio"></select>
        </div>
        <div>
          <label>Дедлайн</label>
          <input class="input" type="date" id="fmDue" />
        </div>
        <div>
          <label>Теги (через запятую)</label>
          <input class="input" id="fmTags" />
        </div>
        <div style="grid-column:1/-1">
          <label>Описание</label>
          <textarea class="input" id="fmDesc" rows="4"></textarea>
        </div>
        <div style="grid-column:1/-1">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
            <label style="margin:0">Вложения</label>
            <input type="file" id="fmFiles" multiple />
          </div>
          <div class="files" id="filesList"></div>
        </div>
      </div>
      <div class="modal-actions">
        <div><button class="btn" id="btnDelete" style="display:none">Удалить задачу</button></div>
        <div>
          <button class="btn" id="btnDownloadAll" title="Скачать все вложения .zip (просто по одному)">Скачать вложения</button>
          <button class="btn btn-primary" id="btnSave">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

<script>
const STATUS_CHOICES = ["Новая","В работе","Ожидает","Готово","Отменена"];
const PRIORITY_CHOICES = ["Низкий","Средний","Высокий","Критично"];
const HEADER_ORDER = ["ID","Название","Статус","Приоритет","Ответственный","Дедлайн","Теги","Описание","Создано","Обновлено","Действия"];

let tasks = [];
let sortState = {key:"Дедлайн", dir:"asc"};
let editingId = null;

const $ = s => document.querySelector(s);

function toISODate(d){ if(!d) return null; const dt = (d instanceof Date)?d:new Date(d); return isNaN(+dt)?null:dt.toISOString(); }
function fromISOToYMD(iso){ if(!iso) return ""; const d=new Date(iso); if(isNaN(+d)) return ""; return d.toISOString().slice(0,10); }
function fromISOToRu(iso){ if(!iso) return ""; const d=new Date(iso); if(isNaN(+d)) return ""; return d.toLocaleDateString('ru-RU'); }
function parseDateLoose(val){ if(!val) return null; if(val instanceof Date&&!isNaN(+val)) return val;
  const s=String(val).trim(); const m1=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m1) return new Date(`${m1[1]}-${m1[2]}-${m1[3]}T12:00:00`);
  const m2=s.match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(m2) return new Date(`${m2[3]}-${m2[2]}-${m2[1]}T12:00:00`);
  const d=new Date(s); return isNaN(+d)?null:d;
}

function fillFilterOptions(){
  $("#fltStatus").innerHTML = `<option value="">Статус — любой</option>` + STATUS_CHOICES.map(x=>`<option>${x}</option>`).join("");
  $("#fltPrio").innerHTML = `<option value="">Приоритет — любой</option>` + PRIORITY_CHOICES.map(x=>`<option>${x}</option>`).join("");
}
["#fltText","#fltAssignee","#fltTags","#fltDueFrom","#fltDueTo","#fltStatus","#fltPrio"].forEach(sel=>{
  $(sel).addEventListener("input", drawRows);
  $(sel).addEventListener("change", drawRows);
});
$("#btnResetFilters").addEventListener("click", ()=>{
  $("#fltText").value=""; $("#fltAssignee").value=""; $("#fltTags").value="";
  $("#fltDueFrom").value=""; $("#fltDueTo").value=""; $("#fltStatus").value=""; $("#fltPrio").value="";
  drawRows();
});

function applySort(data){
  const dir = sortState.dir==="asc" ? 1 : -1;
  const key = sortState.key;
  const prioOrder = {"Критично":0,"Высокий":1,"Средний":2,"Низкий":3};
  return data.slice().sort((a,b)=>{
    const va=a[key], vb=b[key];
    if(key==="ID"){ return (Number(va||0)-Number(vb||0))*dir; }
    if(key==="Дедлайн"||key==="Создано"||key==="Обновлено"){
      const da=va?new Date(va).getTime():Infinity, db=vb?new Date(vb).getTime():Infinity; return (da-db)*dir;
    }
    if(key==="Приоритет"){ const pa=prioOrder[va]??999, pb=prioOrder[vb]??999; return (pa-pb)*dir; }
    return String(va||"").localeCompare(String(vb||""),'ru',{numeric:true})*dir;
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

function renderHeader(){
  const tr = $("#theadRow"); tr.innerHTML="";
  HEADER_ORDER.forEach(h=>{
    const th=document.createElement("th"); th.textContent=h;
    if(h!=="Действия"){ th.addEventListener("click",()=>{ sortState.key===h ? sortState.dir=(sortState.dir==="asc"?"desc":"asc") : (sortState.key=h, sortState.dir="asc"); drawRows();}); }
    tr.appendChild(th);
  });
}

function passFilters(t){
  const text=$("#fltText").value.trim().toLowerCase();
  const st=$("#fltStatus").value, pr=$("#fltPrio").value;
  const asg=$("#fltAssignee").value.trim().toLowerCase();
  const tags=$("#fltTags").value.trim().toLowerCase();
  const df=$("#fltDueFrom").value, dt=$("#fltDueTo").value;
  if(text){ const blob=(t.Название+" "+t.Описание).toLowerCase(); if(!blob.includes(text)) return false; }
  if(st && t.Статус!==st) return false;
  if(pr && t.Приоритет!==pr) return false;
  if(asg && !String(t.Ответственный||"").toLowerCase().includes(asg)) return false;
  if(tags){ const joined=String(t.Теги||"").toLowerCase(); if(!joined.includes(tags.replace(/^#/,""))) return false; }
  if(df){ const td=t.Дедлайн?new Date(t.Дедлайн):null; const from=new Date(df+"T00:00:00"); if(!td||td<from) return false; }
  if(dt){ const td=t.Дедлайн?new Date(t.Дедлайн):null; const to=new Date(dt+"T23:59:59"); if(!td||td>to) return false; }
  return true;
}

function drawRows(){
  const tbody=$("#tbody"); tbody.innerHTML="";
  const filtered=tasks.filter(passFilters);
  const sorted=applySort(filtered);
  sorted.forEach(t=>{
    const tr=document.createElement("tr");

    function addCell(key, html){
      const td=document.createElement("td");
      if(html!==undefined){ td.innerHTML=html; } else { td.textContent = key==="Дедлайн" ? (t.Дедлайн?fromISOToRu(t.Дедлайн):"") : (t[key]??""); }
      tr.appendChild(td); return td;
    }

    addCell("ID", escapeHtml(t.ID??""));

    // Название (клик по строке откроет детали)
    addCell("Название", escapeHtml(t.Название||""));

    // Статус — inline select
    const tdStatus = document.createElement("td");
    const selS = document.createElement("select");
    selS.className="inline"; STATUS_CHOICES.forEach(s=>{ const o=document.createElement("option"); o.textContent=s; o.selected=(t.Статус===s); selS.appendChild(o); });
    selS.addEventListener("click", e=>e.stopPropagation());
    selS.addEventListener("change", ()=>{ t.Статус = selS.value; t.Обновлено = toISODate(new Date()); saveLocalSilent(); });
    tdStatus.appendChild(selS); tr.appendChild(tdStatus);

    // Приоритет — inline select
    const tdPr = document.createElement("td");
    const selP = document.createElement("select");
    selP.className="inline"; PRIORITY_CHOICES.forEach(p=>{ const o=document.createElement("option"); o.textContent=p; o.selected=(t.Приоритет===p); selP.appendChild(o); });
    selP.addEventListener("click", e=>e.stopPropagation());
    selP.addEventListener("change", ()=>{ t.Приоритет = selP.value; t.Обновлено = toISODate(new Date()); saveLocalSilent(); });
    tdPr.appendChild(selP); tr.appendChild(tdPr);

    addCell("Ответственный", escapeHtml(t.Ответственный||""));
    addCell("Дедлайн", escapeHtml(t.Дедлайн?fromISOToRu(t.Дедлайн):""));
    addCell("Теги", t.Теги ? t.Теги.split(",").map(s=>`<span class="tag">${escapeHtml(s.trim())}</span>`).join(" ") : "");
    addCell("Описание", escapeHtml(t.Описание||""));
    addCell("Создано", escapeHtml(t.Создано?fromISOToRu(t.Создано):""));
    addCell("Обновлено", escapeHtml(t.Обновлено?fromISOToRu(t.Обновлено):""));

    const tdAct=document.createElement("td"); tdAct.className="row-actions";
    const btnEdit=document.createElement("button"); btnEdit.className="btn"; btnEdit.textContent="Редактировать";
    btnEdit.addEventListener("click",(e)=>{ e.stopPropagation(); openModal(t.ID); });
    const btnDel=document.createElement("button"); btnDel.className="btn btn-danger"; btnDel.textContent="Удалить";
    btnDel.addEventListener("click",(e)=>{ e.stopPropagation(); if(confirm("Удалить задачу ID="+t.ID+"?")){ tasks=tasks.filter(x=>x.ID!==t.ID); drawRows(); }});
    tdAct.append(btnEdit,btnDel); tr.appendChild(tdAct);

    // Клик по строке — открыть подробности
    tr.addEventListener("click", ()=>openModal(t.ID));

    tbody.appendChild(tr);
  });
}

function nextId(){ const ids=tasks.map(t=>Number(t.ID)||0); const m=ids.length?Math.max(...ids):0; return (isFinite(m)?m:0)+1; }

function openModal(id=null){
  editingId = id;
  $("#modalTitle").textContent = id ? `Задача #${id}` : "Новая задача";
  $("#fmStatus").innerHTML = STATUS_CHOICES.map(x=>`<option>${x}</option>`).join("");
  $("#fmPrio").innerHTML = PRIORITY_CHOICES.map(x=>`<option>${x}</option>`).join("");
  $("#fmTitle").value=""; $("#fmAssignee").value=""; $("#fmDue").value=""; $("#fmTags").value=""; $("#fmDesc").value="";
  $("#filesList").innerHTML=""; $("#fmFiles").value="";
  $("#btnDelete").style.display = id ? "" : "none";
  $("#modal").classList.add("open");

  if(id){
    const t=tasks.find(x=>x.ID===id); if(!t) return;
    $("#fmTitle").value=t.Название||"";
    $("#fmAssignee").value=t.Ответственный||"";
    $("#fmStatus").value=t.Статус||STATUS_CHOICES[0];
    $("#fmPrio").value=t.Приоритет||PRIORITY_CHOICES[1];
    $("#fmDue").value=fromISOToYMD(t.Дедлайн);
    $("#fmTags").value=t.Теги||"";
    $("#fmDesc").value=t.Описание||"";
    renderFiles(t);
  }
}
function closeModal(){ $("#modal").classList.remove("open"); }
$("#btnCloseModal").addEventListener("click", closeModal);

function renderFiles(task){
  const wrap=$("#filesList"); wrap.innerHTML="";
  (task.attachments||[]).forEach((f,idx)=>{
    const card=document.createElement("div"); card.className="file-card";
    if(f.type && f.type.startsWith("image/")){
      const img=document.createElement("img"); img.src=f.dataUrl; card.appendChild(img);
    }else{
      const placeholder=document.createElement("div");
      placeholder.style.height="100px"; placeholder.style.display="flex"; placeholder.style.alignItems="center";
      placeholder.style.justifyContent="center"; placeholder.textContent=f.type||"файл";
      card.appendChild(placeholder);
    }
    const name=document.createElement("div"); name.className="file-name"; name.textContent=f.name; card.appendChild(name);
    const acts=document.createElement("div"); acts.className="file-actions";
    const a=document.createElement("a"); a.href=f.dataUrl; a.download=f.name; a.className="btn"; a.textContent="Скачать";
    const del=document.createElement("button"); del.className="btn btn-danger"; del.textContent="Удалить";
    del.addEventListener("click", ()=>{ const t=tasks.find(x=>x.ID===task.ID); t.attachments.splice(idx,1); renderFiles(t); saveLocalSilent(); });
    acts.append(a,del); card.appendChild(acts);
    wrap.appendChild(card);
  });
}

$("#fmFiles").addEventListener("change", async (e)=>{
  const files=[...e.target.files]; if(!files.length) return;
  const t = tasks.find(x=>x.ID===editingId);
  if(!t && editingId){ return; }
  // собираем список как dataURL
  for(const f of files){
    const dataUrl = await fileToDataURL(f);
    if(editingId){ // к существующей задаче
      t.attachments = t.attachments || [];
      t.attachments.push({name:f.name, type:f.type, size:f.size, dataUrl});
    }else{ // к новой — временно в DOM, сохраним при save()
      tempNewFiles.push({name:f.name, type:f.type, size:f.size, dataUrl});
    }
  }
  if(editingId){ renderFiles(t); saveLocalSilent(); }
});

function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
  });
}

let tempNewFiles = [];

$("#btnDownloadAll").addEventListener("click", ()=>{
  const t = tasks.find(x=>x.ID===editingId);
  if(!t || !(t.attachments||[]).length){ alert("Нет вложений"); return; }
  // Без zip-библиотеки — просто откроем каждое во вкладке/скачивании
  (t.attachments||[]).forEach(f=>{
    const a=document.createElement("a"); a.href=f.dataUrl; a.download=f.name; document.body.appendChild(a); a.click(); a.remove();
  });
});

$("#btnDelete").addEventListener("click", ()=>{
  if(editingId && confirm("Удалить задачу?")){ tasks=tasks.filter(x=>x.ID!==editingId); closeModal(); drawRows(); }
});

$("#btnSave").addEventListener("click", ()=>{
  const title=$("#fmTitle").value.trim(); if(!title){ alert("Введите название"); return; }
  const nowIso=toISODate(new Date());
  let due=null; if($("#fmDue").value){ const d=new Date($("#fmDue").value+"T12:00:00"); if(!isNaN(+d)) due=d; }

  const payload={
    ID: editingId ?? nextId(),
    Название: title,
    Описание: $("#fmDesc").value.trim(),
    Статус: $("#fmStatus").value,
    Приоритет: $("#fmPrio").value,
    Ответственный: $("#fmAssignee").value.trim(),
    Дедлайн: due ? toISODate(due) : null,
    Теги: $("#fmTags").value.trim(),
  };

  if(editingId){
    const i=tasks.findIndex(x=>x.ID===editingId);
    if(i>=0){
      tasks[i] = {...tasks[i], ...payload, Обновлено: nowIso};
    }
  }else{
    const newTask = {...payload, Создано: nowIso, Обновлено: nowIso};
    if(tempNewFiles.length){ newTask.attachments = tempNewFiles.slice(); }
    tasks.push(newTask);
  }
  tempNewFiles = [];
  drawRows(); closeModal(); saveLocalSilent();
});

// Import/Export Excel/CSV & LocalStorage – same as before
const COLUMN_ALIASES = {
  id:["id","ид","код","№","номер","task id","идентификатор","ID"],
  title:["название","тема","задача","title","name","subject","Название"],
  desc:["описание","description","детали","комментарий","comment","Описание"],
  status:["статус","status","state","Статус"],
  priority:["приоритет","priority","prio","Приоритет"],
  assignee:["ответственный","исполнитель","assignee","owner","Ответственный"],
  due:["дедлайн","срок","due","due date","deadline","срок сдачи","Дедлайн"],
  tags:["теги","метки","tags","labels","Теги"],
  created:["создано","дата создания","created","created at","Создано"],
  updated:["обновлено","дата обновления","updated","updated at","Обновлено"]
};
const DEFAULT_COLUMNS = {id:"ID",title:"Название",desc:"Описание",status:"Статус",priority:"Приоритет",assignee:"Ответственный",due:"Дедлайн",tags:"Теги",created:"Создано",updated:"Обновлено"};

function normalizeHeaders(headers){
  const map={};
  for(const norm in COLUMN_ALIASES){
    const variants=COLUMN_ALIASES[norm].map(v=>v.toLowerCase());
    let found=null;
    headers.forEach(h=>{ const low=String(h).trim().toLowerCase(); if(variants.includes(low)||low===DEFAULT_COLUMNS[norm].toLowerCase()) found=h; });
    map[norm]=found || DEFAULT_COLUMNS[norm];
  }
  return {map};
}
function toTaskObject(row,map){
  const get = norm => row[ map[norm] ] ?? row[ DEFAULT_COLUMNS[norm] ];
  const id = Number(get("id")) || null;
  const title = (get("title")??"").toString().trim();
  const desc = (get("desc")??"").toString().trim();
  const status = (get("status")??"").toString().trim();
  const priority = (get("priority")??"").toString().trim();
  const assignee = (get("assignee")??"").toString().trim();
  const due = parseDateLoose(get("due"));
  const tags = (get("tags")??"").toString().trim();
  const created = parseDateLoose(get("created"));
  const updated = parseDateLoose(get("updated"));
  return { ID:id, Название:title, Описание:desc, Статус:status, Приоритет:priority, Ответственный:assignee,
    Дедлайн: due?toISODate(due):null, Теги:tags, Создано:created?toISODate(created):toISODate(new Date()), Обновлено:updated?toISODate(updated):toISODate(new Date()),
    attachments: [] };
}

$("#btnImportExcel").addEventListener("click", ()=>$("#fileExcel").click());
$("#fileExcel").addEventListener("change", async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf,{type:"array"}); const sheet=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(sheet,{defval:""});
    if(!json.length){ alert("Лист пуст"); return; }
    const headers=Object.keys(json[0]); const {map}=normalizeHeaders(headers);
    const imported=json.map(row=>toTaskObject(row,map));
    let cur=nextId(); for(const t of imported){ if(!t.ID) t.ID=cur++; }
    tasks=imported; drawRows(); alert("Импортировано задач: "+tasks.length);
  }catch(err){ console.error(err); alert("Ошибка импорта Excel: "+err.message); }
  finally{ e.target.value=""; }
});

$("#btnExportExcel").addEventListener("click", ()=>{
  const out=tasks.map(t=>({"ID":t.ID,"Название":t.Название,"Описание":t.Описание,"Статус":t.Статус,"Приоритет":t.Приоритет,"Ответственный":t.Ответственный,"Дедлайн":t.Дедлайн?fromISOToYMD(t.Дедлайн):"","Теги":t.Теги,"Создано":t.Создано?fromISOToYMD(t.Создано):"","Обновлено":t.Обновлено?fromISOToYMD(t.Обновлено):""}));
  const ws=XLSX.utils.json_to_sheet(out); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Задачи"); XLSX.writeFile(wb,"Задачи_export.xlsx");
});

$("#btnImportCSV").addEventListener("click", ()=>$("#fileCSV").click());
$("#fileCSV").addEventListener("change", async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const text=await file.text(); const rows=csvParse(text); if(!rows.length){ alert("CSV пуст"); return; }
    const headers=rows[0]; const body=rows.slice(1).map(r=>{const o={}; headers.forEach((h,i)=>o[h]=r[i]||""); return o;});
    const {map}=normalizeHeaders(headers); const imported=body.map(row=>toTaskObject(row,map));
    let cur=nextId(); for(const t of imported){ if(!t.ID) t.ID=cur++; }
    tasks=imported; drawRows(); alert("Импортировано задач: "+tasks.length);
  }catch(err){ console.error(err); alert("Ошибка импорта CSV: "+err.message); }
  finally{ e.target.value=""; }
});
$("#btnExportCSV").addEventListener("click", ()=>{
  const headers=["ID","Название","Описание","Статус","Приоритет","Ответственный","Дедлайн","Теги","Создано","Обновлено"];
  const rows=tasks.map(t=>[t.ID,t.Название,t.Описание,t.Статус,t.Приоритет,t.Ответственный,t.Дедлайн?fromISOToYMD(t.Дедлайн):"",t.Теги||"",t.Создано?fromISOToYMD(t.Создано):"",t.Обновлено?fromISOToYMD(t.Обновлено):""]);
  const csv=csvStringify([headers,...rows]); const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="Задачи_export.csv"; document.body.appendChild(a); a.click(); a.remove();
});
function csvParse(text){
  const rows=[]; let row=[],cur="",inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch=='"'){ if(inQ && text[i+1]=='"'){ cur+='"'; i++; } else inQ=!inQ; }
    else if(ch==',' && !inQ){ row.push(cur); cur=""; }
    else if((ch=='\n'||ch=='\r') && !inQ){ if(cur!==""||row.length){ row.push(cur); rows.push(row); row=[]; cur=""; } if(ch=='\r' && text[i+1]=='\n') i++; }
    else cur+=ch;
  }
  if(cur!==""||row.length){ row.push(cur); rows.push(row); }
  return rows;
}
function csvStringify(rows){
  return rows.map(r=>r.map(v=>{ const s=String(v??""); return /[",\n\r]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }).join(",")).join("\r\n");
}

// LocalStorage
function saveLocalSilent(){ try{ localStorage.setItem("tm_tasks", JSON.stringify(tasks)); }catch(e){} }
$("#btnSaveLocal").addEventListener("click", ()=>{ saveLocalSilent(); alert("Сохранено в браузере."); });
$("#btnLoadLocal").addEventListener("click", ()=>{ const raw=localStorage.getItem("tm_tasks"); if(!raw) return alert("В браузере пусто."); try{ const arr=JSON.parse(raw); if(Array.isArray(arr)){ tasks=arr; drawRows(); alert("Загружено."); }}catch(e){ alert("Ошибка загрузки."); }});
$("#btnClearAll").addEventListener("click", ()=>{ if(confirm("Очистить все задачи?")){ tasks=[]; drawRows(); saveLocalSilent(); }});

document.getElementById("btnAdd").addEventListener("click", ()=>openModal(null));
function init(){
  fillFilterOptions(); renderHeader();
  try{ const raw=localStorage.getItem("tm_tasks"); if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr)) tasks=arr; } }catch(e){}
  drawRows();
}
init();

// ===== JSON Import/Export =====
document.getElementById("btnImportJSON").addEventListener("click", ()=>document.getElementById("fileJSON").click());
document.getElementById("fileJSON").addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);
    if(!Array.isArray(obj)) throw new Error("Формат: ожидается массив задач");
    tasks = obj;
    drawRows(); saveLocalSilent();
    alert("Импортировано задач: "+tasks.length);
  }catch(err){ alert("Ошибка импорта JSON: "+err.message); }
  finally{ e.target.value=""; }
});
document.getElementById("btnExportJSON").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tasks.tm.json"; document.body.appendChild(a); a.click(); a.remove();
});

// ===== Cloud (Google Sheets via Apps Script) =====
const modalCloud = document.getElementById("modalCloud");
document.getElementById("btnCloud").addEventListener("click", ()=>{ 
  // preload settings
  document.getElementById("cloudUrl").value = localStorage.getItem("tm_cloud_url") || "";
  document.getElementById("cloudKey").value = localStorage.getItem("tm_cloud_key") || "";
  document.getElementById("cloudProfile").value = localStorage.getItem("tm_cloud_profile") || "default";
  modalCloud.classList.add("open"); 
});
document.getElementById("btnCloseCloud").addEventListener("click", ()=>modalCloud.classList.remove("open"));

document.getElementById("btnCloudLoad").addEventListener("click", async ()=>{
  const url = document.getElementById("cloudUrl").value.trim();
  const key = document.getElementById("cloudKey").value.trim();
  const profile = document.getElementById("cloudProfile").value.trim() || "default";
  if(!url){ alert("Укажите URL вашего Apps Script веб‑приложения"); return; }
  localStorage.setItem("tm_cloud_url", url);
  localStorage.setItem("tm_cloud_key", key);
  localStorage.setItem("tm_cloud_profile", profile);
  try{
    const resp = await fetch(`${url}?action=get&profile=${encodeURIComponent(profile)}&key=${encodeURIComponent(key)}`, {method:"GET"});
    if(!resp.ok){ throw new Error("HTTP "+resp.status); }
    const data = await resp.json();
    if(!Array.isArray(data.tasks)){ throw new Error("Неверный ответ сервера"); }
    tasks = data.tasks;
    drawRows(); saveLocalSilent();
    alert("Загружено задач: "+tasks.length);
  }catch(err){ alert("Ошибка загрузки: "+err.message); }
});

document.getElementById("btnCloudSave").addEventListener("click", async ()=>{
  const url = document.getElementById("cloudUrl").value.trim();
  const key = document.getElementById("cloudKey").value.trim();
  const profile = document.getElementById("cloudProfile").value.trim() || "default";
  if(!url){ alert("Укажите URL вашего Apps Script веб‑приложения"); return; }
  localStorage.setItem("tm_cloud_url", url);
  localStorage.setItem("tm_cloud_key", key);
  localStorage.setItem("tm_cloud_profile", profile);
  try{
    const resp = await fetch(`${url}?action=save&profile=${encodeURIComponent(profile)}&key=${encodeURIComponent(key)}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ tasks })
    });
    if(!resp.ok){ throw new Error("HTTP "+resp.status); }
    alert("Сохранено в облако.");
  }catch(err){ alert("Ошибка сохранения: "+err.message); }
});


// ===== URL params & Cloud Autosync =====
function b64urlDecode(str){
  try{
    str = str.replace(/-/g,'+').replace(/_/g,'/');
    const pad = str.length % 4; if (pad) str += '='.repeat(4-pad);
    return decodeURIComponent(escape(atob(str)));
  }catch(e){ return ""; }
}
function getQP(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

let CLOUD_URL = null;
let CLOUD_KEY = null;
let CLOUD_PROFILE = null;
let autosyncEnabled = false;
let saveTimer = null;

function setOnlineBadge(state){
  const el = document.getElementById("onlineBadge");
  if(!el) return;
  if(state){
    el.textContent = `ONLINE${CLOUD_PROFILE?` · ${CLOUD_PROFILE}`:""}`;
    el.style.background = "#0b3a22";
    el.style.color = "#b9f6ca";
    el.style.borderColor = "#155e38";
  }else{
    el.textContent = "OFFLINE";
    el.style.background = "#3a1a1a";
    el.style.color = "#fecaca";
    el.style.borderColor = "#7f1d1d";
  }
}

async function cloudLoad(){
  if(!CLOUD_URL) return;
  try{
    const resp = await fetch(`${CLOUD_URL}?action=get&profile=${encodeURIComponent(CLOUD_PROFILE||"default")}&key=${encodeURIComponent(CLOUD_KEY||"")}`);
    if(!resp.ok) throw new Error("HTTP "+resp.status);
    const data = await resp.json();
    if(Array.isArray(data.tasks)){
      tasks = data.tasks;
      drawRows(); saveLocalSilent(); setOnlineBadge(true);
    }
  }catch(e){
    console.warn("cloudLoad error:", e); setOnlineBadge(false);
  }
}
async function cloudSave(){
  if(!CLOUD_URL) return;
  try{
    const resp = await fetch(`${CLOUD_URL}?action=save&profile=${encodeURIComponent(CLOUD_PROFILE||"default")}&key=${encodeURIComponent(CLOUD_KEY||"")}`, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({tasks})
    });
    if(!resp.ok) throw new Error("HTTP "+resp.status);
    setOnlineBadge(true);
  }catch(e){
    console.warn("cloudSave error:", e); setOnlineBadge(false);
  }
}
function scheduleCloudSave(){
  if(!autosyncEnabled) return;
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(cloudSave, 800); // debounce 0.8s
}

// Hook all mutations to schedule save
const origDrawRows = drawRows;
drawRows = function(){
  origDrawRows();
  scheduleCloudSave();
}

// Patch inline changes to schedule save
const origSaveLocal = saveLocalSilent;
saveLocalSilent = function(){
  try{ localStorage.setItem("tm_tasks", JSON.stringify(tasks)); }catch(e){}
  scheduleCloudSave();
}

// Parse URL params
(function(){
  const cloudParam = getQP("cloud"); // base64url-encoded Apps Script URL
  const profileParam = getQP("profile") || getQP("doc") || getQP("id");
  const keyParam = getQP("key") || getQP("token");
  if(cloudParam){
    const decoded = b64urlDecode(cloudParam);
    if(decoded && /^https?:\/\/script\.google\.com\/macros\//.test(decoded)){
      CLOUD_URL = decoded;
      CLOUD_PROFILE = profileParam || "default";
      CLOUD_KEY = keyParam || "";
      autosyncEnabled = true;
      setOnlineBadge(true);
      // Auto-load from cloud on init
      cloudLoad();
    }else{
      console.warn("cloud param not valid");
    }
  } else {
    setOnlineBadge(false);
  }
})();

</script>

  <!-- Cloud Modal -->
  <div class="modal" id="modalCloud">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Облако через Google Sheets (Apps Script)</h3>
        <button class="btn btn-ghost" id="btnCloseCloud">✕</button>
      </div>
      <div class="modal-grid">
        <div style="grid-column:1/-1">
          <label>URL вашего веб-приложения (Apps Script)</label>
          <input class="input" id="cloudUrl" placeholder="https://script.google.com/macros/s/AKfycb.../exec" />
        </div>
        <div>
          <label>Секретный ключ (необязательно)</label>
          <input class="input" id="cloudKey" placeholder="например: my-secret" />
        </div>
        <div>
          <label>Профиль (если хотите несколько наборов)</label>
          <input class="input" id="cloudProfile" placeholder="default" />
        </div>
      </div>
      <div class="modal-actions">
        <div class="hint">Совет: этот HTML ничего никуда не отправляет без вашего явного клика.</div>
        <div>
          <button class="btn" id="btnCloudLoad">Загрузить из облака</button>
          <button class="btn btn-primary" id="btnCloudSave">Сохранить в облако</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
